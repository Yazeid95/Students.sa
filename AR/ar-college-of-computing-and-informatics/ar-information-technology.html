<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ خطة دراسة تقنية المعلومات - Students.sa</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        
        .radio-custom {
            margin-left: 15px;
            margin-right: 0;
        }
        
        .checkbox-custom {
            margin-left: 15px;
            margin-right: 0;
        }
        
        .course-header {
            flex-direction: row-reverse;
        }
        
        .course-actions {
            flex-direction: row-reverse;
        }
        
        .selected-course-item {
            flex-direction: row-reverse;
        }
        
        .plan-content {
            grid-template-columns: 500px 1fr;
        }
        
        .questionnaire-actions {
            flex-direction: row-reverse;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="../../images/seu-students-logo-dark-green.png" alt="شعار طلاب الجامعة السعودية الإلكترونية" class="header-logo dark-logo">
        <img src="../../images/seu-students-logo-gold.png" alt="شعار طلاب الجامعة السعودية الإلكترونية" class="header-logo light-logo">
    </div>

    <div class="top-controls">
        <button class="control-btn" id="themeToggle" onclick="toggleTheme()" title="تغيير الوضع المظلم/المضيء" style="display: none;">
            <svg class="theme-icon" viewBox="0 0 24 24" width="28" height="28">
                <path class="sun-icon" fill="currentColor" d="M12 17.5c-1.38 0-2.63-.56-3.54-1.46A4.98 4.98 0 0 1 7 12c0-1.38.56-2.63 1.46-3.54A4.98 4.98 0 0 1 12 6.5c1.38 0 2.63.56 3.54 1.46A4.98 4.98 0 0 1 17 12c0 1.38-.56 2.63-1.46 3.54A4.98 4.98 0 0 1 12 17.5zm5.5-9.5h2v2h-2V8zm0 8h2v2h-2v-2zM8 8H6v2h2V8zm0 8H6v2h2v-2zm8.5-5.5v-2h2v2h-2zm-13 0v-2h2v2h-2zM12 2v2a8 8 0 1 0 0 16v2c-5.52 0-10-4.48-10-10S6.48 2 12 2z"/>
                <path class="moon-icon" fill="currentColor" style="display: none;" d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"/>
            </svg>
        </button>
        
        <button class="control-btn" id="languageToggle" onclick="toggleLanguage()" title="تغيير اللغة">
            <span class="lang-text" id="langText">EN</span>
        </button>
    </div>

    <!-- Progress Questionnaire -->
    <div class="questionnaire-container" id="questionnaireContainer">
        <div class="questionnaire-card">
            <div class="questionnaire-header">
                <h2 class="questionnaire-title">تقييم التقدم الأكاديمي</h2>
                <p class="questionnaire-subtitle">يرجى الإجابة على هذه الأسئلة لتخصيص خطتك الدراسية</p>
            </div>

            <div class="questions-form">
                <!-- Question 1: Common First Year -->
                <div class="question-group">
                    <h3 class="question-title">1. هل أكملت السنة التحضيرية المشتركة؟</h3>
                    <div class="radio-options">
                        <label class="radio-option">
                            <input type="radio" name="firstYear" value="yes">
                            <span class="radio-custom"></span>
                            نعم، لقد أكملت السنة التحضيرية المشتركة
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="firstYear" value="no">
                            <span class="radio-custom"></span>
                            لا، لم أكملها بعد
                        </label>
                    </div>
                </div>

                <!-- Question 2: Shared Courses -->
                <div class="question-group">
                    <h3 class="question-title">2. أي من هذه المقررات المشتركة قد أكملتها؟</h3>
                    <p class="question-hint">اختر جميع المقررات التي أكملتها</p>
                    <div class="checkbox-grid">
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="ISLM101">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">ISLM101</span>
                                <span class="questionnaire-course-name">الثقافة الإسلامية 1</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="ISLM102">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">ISLM102</span>
                                <span class="questionnaire-course-name">الثقافة الإسلامية 2</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="ISLM103">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">ISLM103</span>
                                <span class="questionnaire-course-name">الثقافة الإسلامية 3</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="ISLM104">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">ISLM104</span>
                                <span class="questionnaire-course-name">الثقافة الإسلامية 4</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="SCI101">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">SCI101</span>
                                <span class="questionnaire-course-name">الفيزياء العامة 1</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="SCI201">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">SCI201</span>
                                <span class="questionnaire-course-name">الفيزياء العامة 2</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="MATH150">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">MATH150</span>
                                <span class="questionnaire-course-name">الرياضيات المتقطعة</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="MATH251">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">MATH251</span>
                                <span class="questionnaire-course-name">الجبر الخطي</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="ENG103">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">ENG103</span>
                                <span class="questionnaire-course-name">الكتابة التقنية</span>
                            </div>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="sharedCourses" value="STAT101">
                            <span class="checkbox-custom"></span>
                            <div class="questionnaire-course-info">
                                <span class="questionnaire-course-code">STAT101</span>
                                <span class="questionnaire-course-name">الإحصاء</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Question 3: Completed Semesters -->
                <div class="question-group">
                    <h3 class="question-title">3. كم فصل دراسي أكملت في تخصص تقنية المعلومات؟</h3>
                    <p class="question-hint">اختر آخر فصل أكملته في التخصص</p>
                    <div class="semester-grid">
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="2">
                            <div class="semester-number">2</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="3">
                            <div class="semester-number">3</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="4">
                            <div class="semester-number">4</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="5">
                            <div class="semester-number">5</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="6">
                            <div class="semester-number">6</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="7">
                            <div class="semester-number">7</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="8">
                            <div class="semester-number">8</div>
                        </label>
                        <label class="semester-option">
                            <input type="radio" name="semesters" value="0">
                            <div class="semester-number">لا شيء</div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="questionnaire-actions">
                <a href="../college-selection.html" class="questionnaire-btn secondary">
                    <svg class="arrow-icon" viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                    العودة لاختيار الكلية
                </a>
                <button class="questionnaire-btn primary" onclick="submitQuestionnaire()" id="submitBtn" disabled>
                    المتابعة إلى خطة الدراسة
                    <svg class="arrow-icon" viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="study-plan-container" id="studyPlanContainer" style="display: none;">
        <!-- Header Section -->
        <div class="plan-header">
            <h1 class="plan-title">خطة دراسة تقنية المعلومات</h1>
            <div class="progress-stats">
                <div class="stat-item">
                    <span class="stat-label">المقررات المكتملة:</span>
                    <span class="stat-value" id="completedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">الساعات المكتملة:</span>
                    <span class="stat-value" id="completedHours">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">المقررات المتبقية:</span>
                    <span class="stat-value" id="remainingCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">الساعات المتبقية:</span>
                    <span class="stat-value" id="remainingHours">0</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="plan-content">
            <!-- Right Side: Term Builder -->
            <div class="term-builder-section">
                <h2 class="section-title">منشئ الفصل الدراسي المخصص</h2>
                
                <!-- Term Summary -->
                <div class="term-summary">
                    <div class="summary-item">
                        <span class="summary-label">المقررات المختارة:</span>
                        <span class="summary-value" id="selectedCoursesCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">إجمالي الساعات:</span>
                        <span class="summary-value" id="totalHours">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">الحد الأقصى للساعات:</span>
                        <span class="summary-value">18</span>
                    </div>
                </div>

                <!-- Selected Courses List -->
                <div class="selected-courses-container">
                    <div class="empty-state" id="emptyState">
                        <p>لم يتم اختيار أي مقررات بعد</p>
                        <small>انقر على زر + بجانب المقررات التي يمكنك التسجيل فيها لإضافتها</small>
                    </div>
                    <div class="selected-courses-list" id="selectedCoursesList">
                        <!-- Selected courses will be added here -->
                    </div>
                </div>

                <!-- Schedule Builder -->
                <div class="schedule-builder" id="scheduleBuilder" style="display: none;">
                    <h3>جدول المقررات</h3>
                    <div class="schedule-options">
                        <label class="schedule-option">
                            <input type="radio" name="scheduleView" value="weekly" checked>
                            العرض الأسبوعي
                        </label>
                        <label class="schedule-option">
                            <input type="radio" name="scheduleView" value="daily">
                            العرض اليومي
                        </label>
                    </div>
                    
                    <div class="schedule-grid" id="scheduleGrid">
                        <!-- Schedule will be generated here -->
                    </div>
                    
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportSchedule('pdf')">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            تصدير PDF
                        </button>
                        <button class="export-btn" onclick="exportSchedule('jpeg')">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                            </svg>
                            تصدير JPEG
                        </button>
                    </div>
                </div>

                <!-- Term Actions -->
                <div class="term-actions">
                    <button class="action-btn secondary" onclick="clearTerm()">مسح الفصل</button>
                    <button class="action-btn schedule" onclick="generateSchedule()" id="scheduleBtn" disabled>إنشاء الجدول</button>
                    <button class="action-btn calendar" onclick="generateCalendar()" id="calendarBtn" disabled>عرض التقويم</button>
                    <button class="action-btn primary" onclick="saveTerm()" id="saveTermBtn" disabled>حفظ الفصل</button>
                </div>
            </div>

            <!-- Left Side: Available Courses -->
            <div class="available-courses-section">
                <h2 class="section-title">المقررات المتاحة للتسجيل</h2>
                
                <div class="available-courses-list" id="availableCoursesList">
                    <!-- Dynamic content will be generated here -->
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation-buttons">
            <button class="nav-btn secondary" onclick="goBack()">
                العودة للاستبيان
            </button>
        </div>

        <!-- Calendar Modal -->
        <div class="calendar-modal" id="calendarModal" style="display: none;">
            <div class="calendar-content">
                <div class="calendar-header">
                    <h2>تقويم جدول المقررات</h2>
                    <button class="close-calendar" onclick="closeCalendar()">×</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be generated here -->
                </div>
                <div class="calendar-actions">
                    <button class="export-calendar-btn" onclick="exportCalendar()">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                        </svg>
                        تصدير كصورة JPEG
                    </button>
                    <button class="close-calendar-btn" onclick="closeCalendar()">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // All course data with prerequisites (Arabic names)
        const allCourses = {
            university: [
                { code: "ENG001", name: "مهارات اللغة الإنجليزية 1", hours: 8, prerequisites: [], category: "university" },
                { code: "ENG002", name: "مهارات اللغة الإنجليزية 2", hours: 8, prerequisites: [], category: "university" },
                { code: "CS001", name: "أساسيات الحاسب الآلي", hours: 3, prerequisites: [], category: "university" },
                { code: "MATH001", name: "أساسيات الرياضيات", hours: 3, prerequisites: [], category: "university" },
                { code: "COMM001", name: "مهارات التواصل", hours: 2, prerequisites: [], category: "university" },
                { code: "CI001", name: "المهارات الأكاديمية", hours: 2, prerequisites: [], category: "university" }
            ],
            shared: [
                { code: "ISLM101", name: "الثقافة الإسلامية 1", hours: 2, prerequisites: [], category: "university" },
                { code: "ISLM102", name: "الثقافة الإسلامية 2", hours: 2, prerequisites: [], category: "university" },
                { code: "ISLM103", name: "الثقافة الإسلامية 3", hours: 2, prerequisites: [], category: "university" },
                { code: "ISLM104", name: "الثقافة الإسلامية 4", hours: 2, prerequisites: [], category: "university" },
                { code: "SCI101", name: "الفيزياء العامة 1", hours: 3, prerequisites: [], category: "college" },
                { code: "SCI201", name: "الفيزياء العامة 2", hours: 3, prerequisites: ["SCI101"], category: "college" },
                { code: "MATH150", name: "الرياضيات المتقطعة", hours: 3, prerequisites: [], category: "college" },
                { code: "MATH251", name: "الجبر الخطي", hours: 3, prerequisites: ["MATH150"], category: "college" },
                { code: "ENG103", name: "الكتابة التقنية", hours: 3, prerequisites: [], category: "college" },
                { code: "STAT101", name: "الإحصاء", hours: 3, prerequisites: [], category: "college" }
            ],
            major: [
                { code: "IT231", name: "مقدمة في تقنية المعلومات ونظم المعلومات", hours: 3, prerequisites: [], category: "major" },
                { code: "IT232", name: "البرمجة الكائنية التوجه", hours: 3, prerequisites: [], category: "major" },
                { code: "IT233", name: "تنظيم الحاسب الآلي", hours: 3, prerequisites: [], category: "major" },
                { code: "IT241", name: "أنظمة التشغيل", hours: 3, prerequisites: ["IT233"], category: "major" },
                { code: "IT244", name: "مقدمة في قواعد البيانات", hours: 3, prerequisites: ["IT232"], category: "major" },
                { code: "IT245", name: "هياكل البيانات", hours: 3, prerequisites: ["IT232"], category: "major" },
                { code: "IT351", name: "شبكات الحاسب الآلي", hours: 3, prerequisites: ["IT241"], category: "major" },
                { code: "IT352", name: "التفاعل بين الإنسان والحاسب", hours: 3, prerequisites: ["IT231", "IT245"], category: "major" },
                { code: "IT353", name: "تحليل وتصميم النظم", hours: 3, prerequisites: ["IT245"], category: "major" },
                { code: "IT354", name: "نظم إدارة قواعد البيانات", hours: 3, prerequisites: ["IT244"], category: "major" },
                { code: "IT361", name: "تقنيات الويب", hours: 3, prerequisites: ["IT352", "IT244"], category: "major" },
                { code: "IT362", name: "إدارة مشاريع تقنية المعلومات", hours: 3, prerequisites: ["IT353"], category: "major" },
                { code: "IT363", name: "إدارة الشبكات", hours: 3, prerequisites: ["IT351"], category: "major" },
                { code: "IT364", name: "ريادة الأعمال والابتكار في تقنية المعلومات", hours: 3, prerequisites: ["IT244"], category: "major" },
                { code: "IT365", name: "نظم المؤسسات", hours: 3, prerequisites: ["IT352"], category: "major" },
                { code: "IT474", name: "مقدمة في الأمن السيبراني والجرائم الرقمية", hours: 3, prerequisites: ["IT363"], category: "major" },
                { code: "IT475", name: "نظم دعم القرار", hours: 3, prerequisites: ["IT354"], category: "major" },
                { code: "IT476", name: "أمن تقنية المعلومات والسياسات", hours: 3, prerequisites: ["IT351"], category: "major" },
                { code: "IT478", name: "أمن الشبكات", hours: 3, prerequisites: ["IT363"], category: "major" },
                { code: "IT479", name: "مشروع التخرج الأول", hours: 3, prerequisites: ["IT354", "IT361"], category: "major" },
                { code: "IT484", name: "شبكات الاستشعار اللاسلكية", hours: 3, prerequisites: ["IT474"], category: "major" },
                { code: "IT485", name: "الأخلاقيات المهنية في تقنية المعلومات", hours: 3, prerequisites: ["IT362"], category: "major" },
                { code: "IT487", name: "موضوعات متقدمة في تقنية المعلومات", hours: 3, prerequisites: ["IT475"], category: "major" },
                { code: "IT488", name: "الطب الشرعي السيبراني", hours: 3, prerequisites: ["IT474"], category: "major" },
                { code: "IT489", name: "مشروع التخرج الثاني", hours: 3, prerequisites: ["IT479"], category: "major" },
                { code: "IT499", name: "التدريب العملي", hours: 3, prerequisites: [], category: "major", hourRequirement: 86 }
            ]
        };

        // State management
        let completedCourses = new Set();
        let selectedTermCourses = new Set();
        let courseSchedule = new Map();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme first
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Check for saved progress and decide which view to show
            if (!checkSavedProgress()) {
                // Show questionnaire if no saved progress
                document.getElementById('questionnaireContainer').style.display = 'block';
                document.getElementById('studyPlanContainer').style.display = 'none';
            } else {
                // Show study plan if there's saved progress
                updateStats();
                renderAvailableCourses();
                initializeTheme();
            }
            
            // Add event listeners for questionnaire
            document.querySelectorAll('input[name="firstYear"], input[name="semesters"]').forEach(input => {
                input.addEventListener('change', checkQuestionnaireCompletion);
            });
            
            // Checkbox buttons (shared courses)
            document.querySelectorAll('input[name="sharedCourses"]').forEach(input => {
                input.addEventListener('change', checkQuestionnaireCompletion);
            });
            
            // Add event listeners for schedule view options
            document.querySelectorAll('input[name="scheduleView"]').forEach(radio => {
                radio.addEventListener('change', renderScheduleGrid);
            });
            
            // Initialize questionnaire state
            checkQuestionnaireCompletion();
        });

        function getAllCourses() {
            return [...allCourses.university, ...allCourses.shared, ...allCourses.major];
        }

        function isPrerequisitesMet(course) {
            const regularPrereqsMet = course.prerequisites.every(prereq => completedCourses.has(prereq));
            
            if (course.hourRequirement) {
                const completedHours = Array.from(completedCourses).reduce((total, courseCode) => {
                    const completedCourse = getAllCourses().find(c => c.code === courseCode);
                    return total + (completedCourse ? completedCourse.hours : 0);
                }, 0);
                return regularPrereqsMet && completedHours >= course.hourRequirement;
            }
            
            return regularPrereqsMet;
        }

        function getAvailableCourses() {
            const allCoursesFlat = getAllCourses();
            return allCoursesFlat.filter(course => 
                !completedCourses.has(course.code) && isPrerequisitesMet(course)
            );
        }

        function renderAvailableCourses() {
            const container = document.getElementById('availableCoursesList');
            let availableCourses = getAvailableCourses();

            const coursesToShow = availableCourses.filter(course => !completedCourses.has(course.code));

            if (coursesToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-courses">
                        <p>📚 لا توجد مقررات متاحة للتسجيل</p>
                        <small>أكمل المزيد من المقررات المطلوبة لفتح خيارات جديدة، أو ربما تكون قد أكملت جميع المقررات المتاحة!</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = coursesToShow.map(course => {
                const isInTerm = selectedTermCourses.has(course.code);
                
                return `
                <div class="course-card" data-course="${course.code}">
                    <div class="course-info">
                        <div class="course-header">
                            <span class="course-code">${course.code}</span>
                            <span class="course-hours">${course.hours} ساعة</span>
                            <span class="course-category">${course.category === 'university' ? 'جامعة' : course.category === 'college' ? 'كلية' : 'تخصص'}</span>
                        </div>
                        <div class="course-name">${course.name}</div>
                        ${course.prerequisites.length > 0 || course.hourRequirement ? 
                            `<div class="prerequisites">
                                <small>المتطلبات: ${course.prerequisites.length > 0 ? course.prerequisites.join(', ') : 'لا شيء'}${course.hourRequirement ? `، ${course.hourRequirement} ساعة مكتملة` : ''}</small>
                            </div>` : ''
                        }
                    </div>
                    <div class="course-actions">
                        ${!isInTerm ? 
                            `<button class="add-course-btn" onclick="addCourseToTerm('${course.code}')" title="إضافة للفصل">+</button>` : 
                            `<button class="add-course-btn" disabled title="مضاف بالفعل للفصل">مضاف</button>`
                        }
                        <button class="done-course-btn" onclick="markCourseCompleted('${course.code}')" title="تحديد كمكتمل">✓</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function addCourseToTerm(courseCode) {
            const course = getAllCourses().find(c => c.code === courseCode);
            if (!course) return;

            const currentHours = Array.from(selectedTermCourses).reduce((total, code) => {
                const c = getAllCourses().find(course => course.code === code);
                return total + (c ? c.hours : 0);
            }, 0);

            if (currentHours + course.hours > 18) {
                alert(`لا يمكن إضافة ${course.code}. سيتجاوز إجمالي الساعات الحد المسموح وهو 18 ساعة (الحالي: ${currentHours}، سيصبح: ${currentHours + course.hours})`);
                return;
            }

            selectedTermCourses.add(courseCode);
            renderAvailableCourses();
            renderSelectedCourses();
            updateTermSummary();
        }

        function markCourseCompleted(courseCode) {
            const course = getAllCourses().find(c => c.code === courseCode);
            if (!course) return;

            if (confirm(`هل تريد تحديد "${course.code} - ${course.name}" كمكتمل؟\n\nسيؤدي هذا إلى فتح المقررات التي تتطلب هذا المقرر كشرط مسبق.`)) {
                completedCourses.add(courseCode);
                selectedTermCourses.delete(courseCode);
                courseSchedule.delete(courseCode);
                
                renderAvailableCourses();
                renderSelectedCourses();
                updateTermSummary();
                updateStats();
                
                showNotification(`تم تحديد ${course.code} كمكتمل! 🎉`);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #22c55e;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function removeCourseFromTerm(courseCode) {
            selectedTermCourses.delete(courseCode);
            courseSchedule.delete(courseCode);
            renderAvailableCourses();
            renderSelectedCourses();
            updateTermSummary();
        }

        function renderSelectedCourses() {
            const container = document.getElementById('selectedCoursesList');
            const emptyState = document.getElementById('emptyState');
            
            if (selectedTermCourses.size === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const selectedCoursesList = Array.from(selectedTermCourses).map(courseCode => {
                const course = getAllCourses().find(c => c.code === courseCode);
                return course;
            }).filter(Boolean);

            container.innerHTML = selectedCoursesList.map(course => `
                <div class="selected-course-item" data-course="${course.code}">
                    <div class="selected-course-info">
                        <span class="selected-course-code">${course.code}</span>
                        <span class="selected-course-name">${course.name}</span>
                        <span class="selected-course-hours">${course.hours} ساعة</span>
                    </div>
                    <div class="course-time-selector">
                        <select class="time-select" onchange="updateCourseTime('${course.code}', this.value)">
                            ${getAvailableTimeOptions(course.code)}
                        </select>
                        <select class="day-select" onchange="updateCourseDays('${course.code}', this.value)">
                            ${getAvailableDayOptions(course.code)}
                        </select>
                        <input type="text" class="crn-input" placeholder="رقم CRN" 
                               value="${getCRNValue(course.code)}"
                               onchange="updateCourseCRN('${course.code}', this.value)">
                    </div>
                    <button class="remove-course-btn" onclick="removeCourseFromTerm('${course.code}')" title="إزالة من الفصل">×</button>
                </div>
            `).join('');
        }

        function getAvailableTimeOptions(currentCourseCode) {
            const timeSlots = [
                { value: '', label: 'اختر الوقت' },
                { value: '08:00-09:15', label: '08:00-09:15' },
                { value: '09:30-10:45', label: '09:30-10:45' },
                { value: '11:00-12:15', label: '11:00-12:15' },
                { value: '12:30-13:45', label: '12:30-13:45' },
                { value: '14:00-15:15', label: '14:00-15:15' },
                { value: '15:30-16:45', label: '15:30-16:45' },
                { value: '17:00-18:15', label: '17:00-18:15' },
                { value: '18:30-19:45', label: '18:30-19:45' }
            ];
            
            const currentCourseSchedule = courseSchedule.get(currentCourseCode);
            const currentTime = currentCourseSchedule?.time;
            
            return timeSlots.map(timeSlot => {
                const isSelected = currentTime === timeSlot.value;
                return `<option value="${timeSlot.value}" ${isSelected ? 'selected' : ''}>${timeSlot.label}</option>`;
            }).join('');
        }

        function getAvailableDayOptions(currentCourseCode) {
            const dayOptions = [
                { value: '', label: 'اختر الأيام' },
                { value: 'U,T', label: 'الأحد والثلاثاء' },
                { value: 'M,W', label: 'الاثنين والأربعاء' },
                { value: 'U,T,W', label: 'الأحد والثلاثاء والأربعاء' },
                { value: 'M,T,W', label: 'الاثنين والثلاثاء والأربعاء' },
                { value: 'U,M,T,W', label: 'الأحد إلى الأربعاء' }
            ];
            
            const currentCourseSchedule = courseSchedule.get(currentCourseCode);
            const currentDays = currentCourseSchedule?.days;
            
            return dayOptions.map(dayOption => {
                const isSelected = currentDays === dayOption.value;
                return `<option value="${dayOption.value}" ${isSelected ? 'selected' : ''}>${dayOption.label}</option>`;
            }).join('');
        }

        function updateTermSummary() {
            const coursesCount = selectedTermCourses.size;
            const totalHours = Array.from(selectedTermCourses).reduce((total, courseCode) => {
                const course = getAllCourses().find(c => c.code === courseCode);
                return total + (course ? course.hours : 0);
            }, 0);

            document.getElementById('selectedCoursesCount').textContent = coursesCount;
            document.getElementById('totalHours').textContent = totalHours;
            
            const saveBtn = document.getElementById('saveTermBtn');
            const scheduleBtn = document.getElementById('scheduleBtn');
            const calendarBtn = document.getElementById('calendarBtn');
            
            saveBtn.disabled = coursesCount === 0;
            scheduleBtn.disabled = coursesCount === 0;
            calendarBtn.disabled = coursesCount === 0;
            
            const hoursElement = document.getElementById('totalHours');
            if (totalHours > 18) {
                hoursElement.style.color = '#ef4444';
            } else if (totalHours > 15) {
                hoursElement.style.color = '#f59e0b';
            } else {
                hoursElement.style.color = '#d4af37';
            }
        }

        function generateCalendar() {
            const calendarModal = document.getElementById('calendarModal');
            calendarModal.style.display = 'flex';
            renderCalendarGrid();
        }

        function closeCalendar() {
            const calendarModal = document.getElementById('calendarModal');
            calendarModal.style.display = 'none';
        }

        function renderCalendarGrid() {
            const calendarGrid = document.getElementById('calendarGrid');
            const timeSlots = [
                '08:00-09:15', '09:30-10:45', '11:00-12:15', '12:30-13:45',
                '14:00-15:15', '15:30-16:45', '17:00-18:15', '18:30-19:45'
            ];
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء'];
            
            let html = `
                <div class="calendar-table-header">
                    <div class="time-column-header">الوقت</div>
                    ${days.map(day => `<div class="day-column-header">${day}</div>`).join('')}
                </div>
            `;
            
            timeSlots.forEach(timeSlot => {
                html += `<div class="calendar-time-row">
                    <div class="calendar-time-cell">${timeSlot}</div>`;
                
                days.forEach(day => {
                    const course = findCourseForTimeAndDay(timeSlot, day);
                    html += `<div class="calendar-day-cell ${course ? 'has-course' : ''}">`;
                    if (course) {
                        html += `
                            <div class="calendar-course-block">
                                <div class="calendar-course-code">${course.code}</div>
                                <div class="calendar-course-name">${course.name}</div>
                                <div class="calendar-course-hours">${course.hours} ساعة</div>
                                ${courseSchedule.get(course.code)?.crn ? `<div class="calendar-course-crn">CRN: ${courseSchedule.get(course.code).crn}</div>` : ''}
                            </div>
                        `;
                    }
                    html += '</div>';
                });
                html += '</div>';
            });
            
            calendarGrid.innerHTML = html;
        }

        function generateSchedule() {
            const scheduleBuilder = document.getElementById('scheduleBuilder');
            scheduleBuilder.style.display = 'block';
            scheduleBuilder.scrollIntoView({ behavior: 'smooth' });
            renderScheduleGrid();
        }

        function renderScheduleGrid() {
            const scheduleGrid = document.getElementById('scheduleGrid');
            const viewType = document.querySelector('input[name="scheduleView"]:checked').value;
            
            if (viewType === 'weekly') {
                renderWeeklySchedule(scheduleGrid);
            } else {
                renderDailySchedule(scheduleGrid);
            }
        }

        function renderWeeklySchedule(container) {
            const timeSlots = [
                '08:00-09:15', '09:30-10:45', '11:00-12:15', '12:30-13:45',
                '14:00-15:15', '15:30-16:45', '17:00-18:15', '18:30-19:45'
            ];
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء'];
            
            let html = `
                <div class="schedule-header">
                    <div class="time-header">الوقت</div>
                    ${days.map(day => `<div class="day-header">${day}</div>`).join('')}
                </div>
            `;
            
            timeSlots.forEach(timeSlot => {
                html += `<div class="time-row">
                    <div class="time-cell">${timeSlot}</div>`;
                
                days.forEach(day => {
                    const course = findCourseForTimeAndDay(timeSlot, day);
                    html += `<div class="schedule-cell ${course ? 'occupied' : ''}">`;
                    if (course) {
                        html += `
                            <div class="course-block">
                                <span class="course-code">${course.code}</span>
                                <span class="course-name">${course.name}</span>
                                ${courseSchedule.get(course.code)?.crn ? `<span class="course-crn">CRN: ${courseSchedule.get(course.code).crn}</span>` : ''}
                            </div>
                        `;
                    }
                    html += '</div>';
                });
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function renderDailySchedule(container) {
            const selectedCourses = Array.from(selectedTermCourses).map(code => {
                const course = getAllCourses().find(c => c.code === code);
                const schedule = courseSchedule.get(code);
                return { ...course, schedule };
            });

            let html = `<div class="daily-schedule">`;
            selectedCourses.forEach(course => {
                if (course.schedule?.time && course.schedule?.days) {
                    html += `
                        <div class="daily-course-item">
                            <div class="course-info">
                                <span class="course-code">${course.code}</span>
                                <span class="course-name">${course.name}</span>
                            </div>
                            <div class="schedule-info">
                                <span class="course-time">${course.schedule.time}</span>
                                <span class="course-days">${course.schedule.days}</span>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function findCourseForTimeAndDay(timeSlot, day) {
            for (const courseCode of selectedTermCourses) {
                const schedule = courseSchedule.get(courseCode);
                if (schedule?.time === timeSlot && schedule?.days?.includes(day.charAt(0))) {
                    return getAllCourses().find(c => c.code === courseCode);
                }
            }
            return null;
        }

        async function exportSchedule(format) {
            const scheduleElement = document.getElementById('scheduleGrid');
            
            if (format === 'pdf') {
                await exportToPDF(scheduleElement);
            } else if (format === 'jpeg') {
                await exportToJPEG(scheduleElement);
            }
        }

        async function exportToPDF(element) {
            try {
                const canvas = await html2canvas(element);
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF();
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('جدول-المقررات.pdf');
            } catch (error) {
                console.error('خطأ في تصدير PDF:', error);
                alert('حدث خطأ أثناء تصدير PDF');
            }
        }

        async function exportToJPEG(element) {
            try {
                const canvas = await html2canvas(element);
                const link = document.createElement('a');
                link.download = 'جدول-المقررات.jpg';
                link.href = canvas.toDataURL('image/jpeg');
                link.click();
            } catch (error) {
                console.error('خطأ في تصدير JPEG:', error);
                alert('حدث خطأ أثناء تصدير JPEG');
            }
        }

        function updateCourseDays(courseCode, days) {
            if (!courseSchedule.has(courseCode)) {
                courseSchedule.set(courseCode, {});
            }
            courseSchedule.get(courseCode).days = days;
            renderSelectedCourses();
        }

        function updateCourseTime(courseCode, time) {
            if (!courseSchedule.has(courseCode)) {
                courseSchedule.set(courseCode, {});
            }
            courseSchedule.get(courseCode).time = time;
            renderSelectedCourses();
        }

        function updateCourseCRN(courseCode, crn) {
            if (!courseSchedule.has(courseCode)) {
                courseSchedule.set(courseCode, {});
            }
            courseSchedule.get(courseCode).crn = crn;
        }

        function getCRNValue(courseCode) {
            const schedule = courseSchedule.get(courseCode);
            return schedule?.crn || '';
        }

        function updateStats() {
            const allCoursesFlat = getAllCourses();
            const completedCount = completedCourses.size;
            const totalCount = allCoursesFlat.length;
            const remainingCount = totalCount - completedCount;
            
            const completedHours = Array.from(completedCourses).reduce((total, courseCode) => {
                const course = getAllCourses().find(c => c.code === courseCode);
                return total + (course ? course.hours : 0);
            }, 0);
            
            const totalHours = allCoursesFlat.reduce((total, course) => total + course.hours, 0);
            const remainingHours = totalHours - completedHours;

            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('completedHours').textContent = completedHours;
            document.getElementById('remainingCount').textContent = remainingCount;
            document.getElementById('remainingHours').textContent = remainingHours;
        }

        function clearTerm() {
            selectedTermCourses.clear();
            courseSchedule.clear();
            document.getElementById('scheduleBuilder').style.display = 'none';
            renderAvailableCourses();
            renderSelectedCourses();
            updateTermSummary();
        }

        function saveTerm() {
            if (selectedTermCourses.size === 0) return;
            
            const selectedCourses = Array.from(selectedTermCourses);
            const totalHours = Array.from(selectedTermCourses).reduce((total, courseCode) => {
                const course = getAllCourses().find(c => c.code === courseCode);
                return total + (course ? course.hours : 0);
            }, 0);
            
            const savedTerms = JSON.parse(localStorage.getItem('savedTerms') || '[]');
            savedTerms.push({
                courses: selectedCourses,
                schedule: Object.fromEntries(courseSchedule),
                totalHours: totalHours,
                createdAt: new Date().toISOString()
            });
            localStorage.setItem('savedTerms', JSON.stringify(savedTerms));
            
            alert(`تم حفظ الفصل بنجاح!\nالمقررات: ${selectedCourses.length}\nإجمالي الساعات: ${totalHours}`);
        }

        function goBack() {
            document.getElementById('studyPlanContainer').style.display = 'none';
            document.getElementById('questionnaireContainer').style.display = 'block';
        }

        // Questionnaire functionality
        let userProgress = {
            firstYear: null,
            sharedCourses: [],
            semesters: null
        };

        function checkQuestionnaireCompletion() {
            const firstYear = document.querySelector('input[name="firstYear"]:checked');
            const semesters = document.querySelector('input[name="semesters"]:checked');
            const submitBtn = document.getElementById('submitBtn');
            
            if (firstYear && semesters) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function submitQuestionnaire() {
            userProgress.firstYear = document.querySelector('input[name="firstYear"]:checked')?.value;
            userProgress.semesters = parseInt(document.querySelector('input[name="semesters"]:checked')?.value);
            
            userProgress.sharedCourses = Array.from(document.querySelectorAll('input[name="sharedCourses"]:checked'))
                .map(input => input.value);

            localStorage.setItem('itProgressData', JSON.stringify(userProgress));
            markCoursesBasedOnProgress();
            
            document.getElementById('questionnaireContainer').style.display = 'none';
            document.getElementById('studyPlanContainer').style.display = 'block';
            
            initializeWithProgress();
        }

        function markCoursesBasedOnProgress() {
            completedCourses.clear();

            if (userProgress.firstYear === 'yes') {
                const firstYearCourses = ['ENG001', 'ENG002', 'CS001', 'MATH001', 'COMM001', 'CI001'];
                firstYearCourses.forEach(courseCode => {
                    completedCourses.add(courseCode);
                });
            }

            userProgress.sharedCourses.forEach(courseCode => {
                completedCourses.add(courseCode);
            });

            const semesterCourses = {
                3: ['IT231', 'IT232', 'IT233'],
                4: ['IT241', 'IT244', 'IT245'],
                5: ['IT351', 'IT352', 'IT353', 'IT354'],
                6: ['IT361', 'IT362', 'IT363', 'IT364', 'IT365'],
                7: ['IT474', 'IT475', 'IT476', 'IT478', 'IT479'],
                8: ['IT484', 'IT485', 'IT487', 'IT488', 'IT489', 'IT499']
            };

            for (let sem = 3; sem <= userProgress.semesters; sem++) {
                if (semesterCourses[sem]) {
                    semesterCourses[sem].forEach(courseCode => {
                        completedCourses.add(courseCode);
                    });
                }
            }

            updateStats();
        }

        function initializeWithProgress() {
            renderAvailableCourses();
            updateStats();
            
            const completedCoursesCount = completedCourses.size;
            const totalHours = Array.from(completedCourses).reduce((total, courseCode) => {
                const course = getAllCourses().find(c => c.code === courseCode);
                return total + (course ? course.hours : 0);
            }, 0);

            showNotification(`تم تحديث التقدم! 
✅ المقررات المكتملة: ${completedCoursesCount}
📚 إجمالي الساعات: ${totalHours}
🎯 يتم عرض المقررات المتاحة للتسجيل فقط.`);
        }

        function checkSavedProgress() {
            const savedData = localStorage.getItem('itProgressData');
            if (savedData) {
                userProgress = JSON.parse(savedData);
                if (confirm('وجدنا تقدمك السابق. هل تريد المتابعة من حيث توقفت؟')) {
                    markCoursesBasedOnProgress();
                    document.getElementById('questionnaireContainer').style.display = 'none';
                    document.getElementById('studyPlanContainer').style.display = 'block';
                    initializeWithProgress();
                    return true;
                }
            }
            return false;
        }

        async function exportCalendar() {
            const calendarElement = document.getElementById('calendarGrid');
            
            try {
                const canvas = await html2canvas(calendarElement);
                const link = document.createElement('a');
                link.download = 'تقويم-المقررات.jpg';
                link.href = canvas.toDataURL('image/jpeg');
                link.click();
            } catch (error) {
                console.error('خطأ في تصدير التقويم:', error);
                alert('حدث خطأ أثناء تصدير التقويم');
            }
        }

        // Theme and language functions
        function toggleTheme() {
            console.log('تم إخفاء تبديل النمط مؤقتاً');
            return;
        }

        function toggleLanguage() {
            window.location.href = '../../EN/college-of-computing-and-informatics/information-technology.html';
        }

        function initializeTheme() {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            
            if (sunIcon) sunIcon.style.display = 'block';
            if (moonIcon) moonIcon.style.display = 'none';
        }
    </script>
</body>
</html>
